name: EventProxPart (FlowAgility eventos + participantes) Beta

on:
  workflow_dispatch:
    inputs:
      limit_events:
        description: "M√°ximo de eventos a procesar"
        required: false
        default: "2"
      max_runtime_min:
        description: "Tiempo m√°ximo de ejecuci√≥n (minutos)"
        required: false
        default: "15"

permissions:
  contents: read

jobs:
  run-scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      OUT_DIR: "./output"
      HEADLESS: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium beautifulsoup4 python-dotenv

      - name: Create output directory
        run: mkdir -p $OUT_DIR

      - name: Create .env file
        run: |
          echo "FLOW_EMAIL=${{ secrets.FLOW_EMAILRQ }}" > .env
          echo "FLOW_PASS=${{ secrets.FLOW_PASSRQ }}" >> .env
          echo "HEADLESS=true" >> .env
          echo "OUT_DIR=./output" >> .env

      - name: Run scraper
        timeout-minutes: 30
        run: |
          echo "üîß Ejecutando scraper..."
          if [ -f "EventosProxParticipantesDeep.py" ]; then
            python EventosProxParticipantesDeep.py --module all
          else
            echo "‚ùå Error: No se encuentra el archivo EventosProxParticipantesDeep.py"
            exit 1
          fi

      - name: Analyze JSON content
        run: |
          echo "=== AN√ÅLISIS DE CONTENIDO JSON ==="
          
          # M√©todo simple y seguro
          if [ -f "$OUT_DIR/01events.json" ]; then
            echo "üìä 01events.json:"
            count=$(python3 -c "import json; print(len(json.load(open('$OUT_DIR/01events.json'))))" 2>/dev/null || echo "Error")
            echo "   Eventos encontrados: $count"
          else
            echo "‚ùå 01events.json no existe"
          fi
          
          if [ -f "$OUT_DIR/02info.json" ]; then
            echo "üìä 02info.json:"
            python3 -c "
import json
try:
    data = json.load(open('$OUT_DIR/02info.json', 'r', encoding='utf-8'))
    with_parts = [e for e in data if e.get('numero_participantes', 0) > 0]
    total = sum(e.get('numero_participantes', 0) for e in data)
    print(f'   Eventos con participantes: {len(with_parts)}')
    print(f'   Total participantes: {total}')
except Exception as e:
    print('   Error analizando el archivo')
"
          else
            echo "‚ùå 02info.json no existe"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scraper-results
          path: output/
          retention-days: 7
